# Deployment Guide - Render

This guide covers deploying Ink Wave Digital to Render using the Blueprint configuration.

## Prerequisites

- GitHub repository connected to Render
- Clerk account with API keys
- Cloudflare R2 bucket configured
- Custom domain (optional but recommended)

## Quick Start

1. Push your code to GitHub
2. Go to [Render Dashboard](https://dashboard.render.com)
3. Click "New" → "Blueprint"
4. Connect your GitHub repository
5. Render will detect `render.yaml` and create all services
6. Add environment variables (see below)
7. Deploy!

## Environment Variables Checklist

### API Service (`inkwave-api`)

Add these in Render Dashboard → inkwave-api → Environment:

```bash
# Auto-populated by Render
DATABASE_URL=<auto-populated-from-database>
JWT_SECRET=<auto-generated-by-render>

# CORS Configuration (update with your actual domains)
CORS_ORIGINS=https://yourdomain.com,https://dashboard.yourdomain.com,http://localhost:5173,http://localhost:5174

# Clerk Authentication
CLERK_SECRET_KEY=sk_live_xxxxxxxxxxxxxxxxxxxxx

# Cloudflare R2 Storage
R2_ACCOUNT_ID=your-cloudflare-account-id
R2_ACCESS_KEY_ID=your-r2-access-key-id
R2_SECRET_ACCESS_KEY=your-r2-secret-access-key
R2_BUCKET_NAME=inkwave-images
R2_PUBLIC_URL=https://pub-xxxxxxxxxxxxx.r2.dev
```

### Customer PWA (`inkwave-customer`)

Add these in Render Dashboard → inkwave-customer → Environment:

```bash
# API URL (use your actual API service URL from Render)
VITE_API_BASE_URL=https://inkwave-api.onrender.com
```

### Dashboard (`inkwave-dashboard`)

Add these in Render Dashboard → inkwave-dashboard → Environment:

```bash
# API URL (use your actual API service URL from Render)
VITE_API_BASE_URL=https://inkwave-api.onrender.com

# Clerk Configuration
VITE_CLERK_PUBLISHABLE_KEY=pk_live_xxxxxxxxxxxxxxxxxxxxx
```

## Getting Your Keys

### Clerk Keys

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Select your application
3. Go to "API Keys"
4. Copy:
   - `CLERK_SECRET_KEY` (starts with `sk_live_` or `sk_test_`)
   - `VITE_CLERK_PUBLISHABLE_KEY` (starts with `pk_live_` or `pk_test_`)

### Cloudflare R2 Keys

1. Go to [Cloudflare Dashboard](https://dash.cloudflare.com)
2. Navigate to R2 → Overview
3. Create an R2 bucket (e.g., `inkwave-images`)
4. Go to "Manage R2 API Tokens"
5. Create a new API token with read/write permissions
6. Copy:
   - Account ID
   - Access Key ID
   - Secret Access Key
7. Get your public URL from bucket settings

### Generate JWT Secret

Run this command to generate a secure JWT secret:

```bash
openssl rand -base64 32
```

## Custom Domain Setup

### 1. Configure in Render

For each service, go to Settings → Custom Domain:

**API:**
- Add: `api.yourdomain.com`

**Customer PWA:**
- Add: `yourdomain.com` or `order.yourdomain.com`

**Dashboard:**
- Add: `dashboard.yourdomain.com`

### 2. Configure DNS

In your DNS provider (e.g., Cloudflare, Namecheap), add CNAME records:

```
Type    Name        Value
CNAME   api         inkwave-api.onrender.com
CNAME   @           inkwave-customer.onrender.com
CNAME   dashboard   inkwave-dashboard.onrender.com
```

**Note:** For root domain (`@`), some providers require ALIAS or ANAME records instead of CNAME.

### 3. Update Environment Variables

After custom domains are active, update:

**API Service:**
```bash
CORS_ORIGINS=https://yourdomain.com,https://dashboard.yourdomain.com
```

**Customer PWA:**
```bash
VITE_API_BASE_URL=https://api.yourdomain.com
```

**Dashboard:**
```bash
VITE_API_BASE_URL=https://api.yourdomain.com
```

Then redeploy the frontend services to apply changes.

## Clerk Configuration

### Update Allowed Origins

1. Go to Clerk Dashboard → Your App → Settings
2. Under "Allowed origins", add:
   - `https://dashboard.yourdomain.com`
   - `https://yourdomain.com` (if customer app uses Clerk)

### Update Redirect URLs

1. Go to Clerk Dashboard → Your App → Paths
2. Add production URLs:
   - Sign-in URL: `https://dashboard.yourdomain.com/sign-in`
   - Sign-up URL: `https://dashboard.yourdomain.com/sign-up`
   - After sign-in: `https://dashboard.yourdomain.com/`
   - After sign-up: `https://dashboard.yourdomain.com/`

## Database Migrations

Migrations run automatically on each API deployment via the `preDeployCommand` in `render.yaml`.

To manually run migrations:

1. Go to Render Dashboard → inkwave-api
2. Click "Shell"
3. Run:
   ```bash
   cd packages/db
   pnpm run migrate:prod
   ```

## Post-Deployment Verification

### 1. Check Service Health

**API:**
```bash
curl https://api.yourdomain.com/health
# Expected: {"status":"ok","timestamp":"..."}
```

**Customer PWA:**
```bash
curl -I https://yourdomain.com
# Expected: HTTP/2 200
```

**Dashboard:**
```bash
curl -I https://dashboard.yourdomain.com
# Expected: HTTP/2 200
```

### 2. Test Core Functionality

1. **Dashboard Login:**
   - Visit `https://dashboard.yourdomain.com`
   - Sign in with Clerk
   - Verify dashboard loads

2. **Create Test Table:**
   - Go to Table Management
   - Create a test table
   - Generate QR code

3. **Customer Flow:**
   - Scan QR code (or visit URL)
   - Verify menu loads
   - Add items to cart
   - Place test order

4. **KDS:**
   - Go to KDS page in dashboard
   - Verify order appears
   - Update order status
   - Verify WebSocket updates work

### 3. Monitor Logs

Check logs in Render Dashboard for each service:
- Look for startup messages
- Check for any errors
- Verify database connection

## Troubleshooting

### API Won't Start

**Check:**
1. Database connection (DATABASE_URL)
2. All required environment variables are set
3. Migrations completed successfully
4. Logs for specific error messages

**Solution:**
```bash
# In Render Shell
echo $DATABASE_URL  # Verify database URL
cd packages/db && pnpm run migrate:prod  # Run migrations manually
```

### Frontend Shows API Error

**Check:**
1. `VITE_API_BASE_URL` is correct
2. CORS_ORIGINS includes frontend domain
3. API is running and healthy

**Solution:**
1. Verify API health endpoint
2. Check browser console for CORS errors
3. Update CORS_ORIGINS and redeploy API
4. Redeploy frontend after API URL change

### Clerk Authentication Fails

**Check:**
1. Clerk keys are correct
2. Production domains added to Clerk
3. Redirect URLs configured

**Solution:**
1. Verify keys in Render match Clerk dashboard
2. Add production domains to Clerk allowed origins
3. Clear browser cache and cookies

### Images Not Uploading

**Check:**
1. R2 credentials are correct
2. R2 bucket exists and is accessible
3. API has proper permissions

**Solution:**
1. Test R2 credentials locally
2. Verify bucket CORS settings
3. Check API logs for R2 errors

### Database Migration Fails

**Check:**
1. DATABASE_URL is accessible
2. Migration files exist in deployment
3. Sufficient database permissions

**Solution:**
1. Check database connection from Render Shell
2. Verify migrations directory is copied in Dockerfile
3. Run migrations manually via Shell

## Rollback Procedure

If deployment fails or has issues:

### 1. Rollback Service

In Render Dashboard:
1. Go to the affected service
2. Click "Deploys" tab
3. Find the last working deployment
4. Click "Redeploy"

### 2. Rollback Database (if needed)

**Warning:** Database rollbacks are complex. Avoid if possible.

If you must rollback:
1. Connect to database via Render Shell
2. Use `psql` to manually revert schema changes
3. Or restore from backup (if available)

**Prevention:** Always test migrations locally first!

## Monitoring

### Health Checks

Render automatically monitors:
- API health endpoint (`/health`)
- Service uptime
- Response times

### Logs

Access logs in Render Dashboard:
- Real-time log streaming
- Historical logs (last 7 days on free tier)
- Filter by service and severity

### Alerts

Set up alerts in Render:
1. Go to service → Settings → Alerts
2. Configure email/Slack notifications
3. Set thresholds for:
   - Failed health checks
   - High memory usage
   - Deployment failures

## Cost Optimization

Current setup (~$14/month):
- PostgreSQL Starter: $7/month
- API Web Service Starter: $7/month
- Static Sites: Free

**To reduce costs:**
1. Use free PostgreSQL tier (Supabase/Neon) - saves $7/month
2. Use Render free tier for API (with limitations)
3. Scale down during low-traffic periods

## Backup Strategy

### Database Backups

Render PostgreSQL includes:
- Daily automatic backups (retained for 7 days on Starter)
- Point-in-time recovery

**Manual backup:**
```bash
# In Render Shell
pg_dump $DATABASE_URL > backup.sql
```

### Code Backups

- Code is in Git (already backed up)
- Render keeps deployment history
- Can redeploy any previous version

## Security Checklist

- [ ] All environment variables are set as secrets (not visible in logs)
- [ ] JWT_SECRET is strong and unique
- [ ] CORS_ORIGINS only includes your domains
- [ ] Clerk production keys are used (not test keys)
- [ ] R2 bucket has proper CORS settings
- [ ] Database has strong password
- [ ] HTTPS is enabled (automatic with Render)
- [ ] Security headers are configured (in nginx.conf)

## Support

- **Render Docs:** https://render.com/docs
- **Clerk Docs:** https://clerk.com/docs
- **Cloudflare R2 Docs:** https://developers.cloudflare.com/r2/

## Next Steps

After successful deployment:

1. Set up monitoring and alerts
2. Configure backup schedule
3. Test disaster recovery procedure
4. Document any custom configurations
5. Set up staging environment (optional)
6. Configure CI/CD pipeline (optional)
7. Add custom error pages
8. Set up analytics
9. Configure CDN (if needed)
10. Performance testing and optimization

---

**Deployment Date:** _____________

**Deployed By:** _____________

**Production URLs:**
- API: _____________
- Customer: _____________
- Dashboard: _____________

